name: Weekly upstream build & release

on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Build & release even if upstream has no new commits'
        required: false
        default: 'false'

env:
  UPSTREAM_REPO: Universal-Debloater-Alliance/universal-android-debloater-next-generation
  UPSTREAM_BRANCH: main
  TARGET_BRANCH: main

jobs:
  sync:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    outputs:
      updated: ${{ steps.check.outputs.updated }}
    steps:
      - name: Checkout fork (main)
        uses: actions/checkout@v4
        with:
          ref: ${{ env.TARGET_BRANCH }}
          fetch-depth: 0

      - name: Add upstream & fetch
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git
          git fetch upstream ${{ env.UPSTREAM_BRANCH }}
          git fetch origin  ${{ env.TARGET_BRANCH }} || true

      - name: Check if upstream is newer
        id: check
        run: |
          UPSTREAM_SHA=$(git rev-parse upstream/${{ env.UPSTREAM_BRANCH }})
          LOCAL_SHA=$(git rev-parse ${{ env.TARGET_BRANCH }})
          if [ "$UPSTREAM_SHA" = "$LOCAL_SHA" ]; then
            echo "updated=false" >> $GITHUB_OUTPUT
          else
            echo "updated=true" >> $GITHUB_OUTPUT
          fi

      - name: Fast-forward from upstream
        if: steps.check.outputs.updated == 'true'
        run: |
          git checkout ${{ env.TARGET_BRANCH }}
          git merge --ff-only upstream/${{ env.UPSTREAM_BRANCH }}
          git push origin ${{ env.TARGET_BRANCH }}

  build:
    needs: sync
    if: needs.sync.outputs.updated == 'true' || github.event.inputs.force_build == 'true'
    uses: ./.github/workflows/build_artifacts.yml

  release:
    needs: build
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      # 這裡「只」抓 windows 那顆 artifact
      - name: Download windows artifact
        uses: actions/download-artifact@v4
        with:
          name: uad-ng-windows
          path: ./artifacts

      - name: Make tag name
        id: tag
        run: |
          TAG="auto-$(date -u +%F)"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Create release (windows exe only)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Weekly upstream build ${{ steps.tag.outputs.tag }}
          # 只丟 exe，也可以順便丟 checksum
          files: |
            artifacts/uad-ng-windows.exe
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
