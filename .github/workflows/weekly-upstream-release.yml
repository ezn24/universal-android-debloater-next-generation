name: Weekly upstream build & release

on:
  schedule:
    - cron: '0 0 * * 0'   # 每週日 00:00 UTC
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Run build/release even if no upstream updates'
        required: false
        default: 'false'

env:
  # 原始專案
  UPSTREAM_REPO: Universal-Debloater-Alliance/universal-android-debloater-next-generation
  UPSTREAM_BRANCH: main
  # 這裡改成你 fork 的 main
  TARGET_BRANCH: main

jobs:
  sync:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    outputs:
      updated: ${{ steps.check.outputs.updated }}
    steps:
      - name: Checkout fork (use main)
        uses: actions/checkout@v4
        with:
          ref: main           # 這裡用你有的分支就不會炸
          fetch-depth: 0

      - name: Add upstream & fetch
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git
          git fetch upstream ${{ env.UPSTREAM_BRANCH }}
          git fetch origin  ${{ env.TARGET_BRANCH }} || true

      - name: Ensure on target branch (main)
        run: |
          # main 一定會有，但還是保險寫一下
          git checkout ${{ env.TARGET_BRANCH }}

      - name: Check if upstream is newer
        id: check
        run: |
          UPSTREAM_SHA=$(git rev-parse upstream/${{ env.UPSTREAM_BRANCH }})
          LOCAL_SHA=$(git rev-parse ${{ env.TARGET_BRANCH }})
          if [ "$UPSTREAM_SHA" = "$LOCAL_SHA" ]; then
            echo "updated=false" >> $GITHUB_OUTPUT
          else
            echo "updated=true" >> $GITHUB_OUTPUT
          fi

      - name: Merge from upstream
        if: steps.check.outputs.updated == 'true'
        run: |
          git merge --ff-only upstream/${{ env.UPSTREAM_BRANCH }}
          git push origin ${{ env.TARGET_BRANCH }}

      - name: Upload synced repo
        if: steps.check.outputs.updated == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: synced-repo
          path: .

  build:
    needs: sync
    # 有更新就 build，或者手動時 force_build=true 也要 build
    if: needs.sync.outputs.updated == 'true' || github.event.inputs.force_build == 'true'
    runs-on: ubuntu-22.04
    steps:
      # 如果是強制 build 但上面沒上傳，就直接 checkout main
      - name: Checkout fallback
        if: github.event.inputs.force_build == 'true' && needs.sync.outputs.updated != 'true'
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Download synced repo
        if: needs.sync.outputs.updated == 'true'
        uses: actions/download-artifact@v4
        with:
          name: synced-repo
          path: .

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build release
        run: |
          cargo build --release

      - name: Upload built binary
        uses: actions/upload-artifact@v4
        with:
          name: uad-ng
          path: target/release/*

  release:
    needs: build
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: ./artifacts
      - name: Make tag name
        id: tag
        run: |
          TAG="auto-$(date -u +%F)"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Weekly upstream build ${{ steps.tag.outputs.tag }}
          files: artifacts/**/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
